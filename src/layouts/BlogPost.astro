---
import BaseLayout from './BaseLayout.astro';
import CTABanner from '../components/CTABanner.astro';
import TableOfContents from '../components/TableOfContents.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import AuthorBio from '../components/AuthorBio.astro';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    publishDate: string;
    updateDate?: string;
    image?: string;
    pillar?: string;
    keywords?: string[];
    cta?: string;
    readingTime?: string;
    noindex?: boolean;
    showToc?: boolean;
  };
  headings?: { depth: number; slug: string; text: string }[];
}

const { frontmatter, headings = [] } = Astro.props;

const {
  title,
  description,
  publishDate,
  updateDate,
  image,
  pillar,
  keywords = [],
  cta = 'try-otherwhere',
  readingTime,
  noindex = false,
  showToc = true,
} = frontmatter;

// Article schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": image,
  "author": {
    "@type": "Organization",
    "name": "Otherwhere"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Otherwhere",
    "url": "https://otherwhere.world"
  },
  "datePublished": publishDate,
  "dateModified": updateDate || publishDate,
  "keywords": keywords.join(', ')
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://blog.otherwhere.world"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": title
    }
  ]
};

const schemas = [articleSchema, breadcrumbSchema];
---

<BaseLayout
  title={`${title} | Otherwhere Blog`}
  description={description}
  image={image}
  noindex={noindex}
  schema={schemas}
>
  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="reading-progress w-0"></div>

  <article class="max-w-3xl mx-auto px-4 py-12">
    <!-- Article Header -->
    <header class="mb-12">
      <div class="flex items-center gap-4 text-body-sm text-ink-tertiary mb-4">
        <time datetime={publishDate}>
          {new Date(publishDate).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </time>
        {readingTime && (
          <>
            <span>·</span>
            <span>{readingTime}</span>
          </>
        )}
        {pillar && (
          <>
            <span>·</span>
            <span class="capitalize">{pillar.replace(/-/g, ' ')}</span>
          </>
        )}
      </div>
      <h1 class="text-display-lg md:text-display-xl mb-6 text-balance">
        {title}
      </h1>
      <p class="text-body-lg text-ink-secondary">
        {description}
      </p>
    </header>

    <!-- Table of Contents -->
    {showToc && headings.length > 2 && (
      <TableOfContents headings={headings} />
    )}

    <!-- Article Content -->
    <div class="prose prose-otherwhere prose-lg max-w-none">
      <slot />
    </div>

    <!-- CTA Section -->
    <div class="mt-12">
      <CTABanner variant={cta} />
    </div>

    <!-- Author Bio -->
    <AuthorBio />

    <!-- Related Posts -->
    <RelatedPosts pillar={pillar} currentSlug={Astro.url.pathname} />
  </article>
</BaseLayout>

<script>
  // Reading progress indicator
  const progressBar = document.getElementById('reading-progress');
  if (progressBar) {
    window.addEventListener('scroll', () => {
      const article = document.querySelector('article');
      if (article) {
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.scrollY;

        const progress = Math.min(
          100,
          Math.max(0, ((scrollTop - articleTop + windowHeight) / articleHeight) * 100)
        );
        progressBar.style.width = `${progress}%`;
      }
    });
  }
</script>
