---
import BaseLayout from './BaseLayout.astro';
import CTABanner from '../components/CTABanner.astro';
import TableOfContents from '../components/TableOfContents.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import AuthorBio from '../components/AuthorBio.astro';
import CalloutBox from '../components/CalloutBox.astro';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    publishDate: string;
    updateDate?: string;
    image?: string;
    imageAlt?: string;
    pillar?: string;
    keywords?: string[];
    cta?: string;
    readingTime?: string;
    noindex?: boolean;
    showToc?: boolean;
  };
  headings?: { depth: number; slug: string; text: string }[];
}

const { frontmatter, headings = [] } = Astro.props;

const {
  title,
  description,
  publishDate,
  updateDate,
  image,
  imageAlt,
  pillar,
  keywords = [],
  cta = 'try-otherwhere',
  readingTime,
  noindex = false,
  showToc = true,
} = frontmatter;

// Article schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": image,
  "author": {
    "@type": "Organization",
    "name": "Otherwhere"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Otherwhere",
    "url": "https://otherwhere.world"
  },
  "datePublished": publishDate,
  "dateModified": updateDate || publishDate,
  "keywords": keywords.join(', ')
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://blog.otherwhere.world"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": title
    }
  ]
};

const schemas = [articleSchema, breadcrumbSchema];
---

<BaseLayout
  title={`${title} | Otherwhere Blog`}
  description={description}
  image={image}
  noindex={noindex}
  schema={schemas}
>
  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="reading-progress w-0"></div>

  <article class="py-12">
    <!-- Hero Image - Full width -->
    {image && (
      <div class="max-w-5xl mx-auto px-4 mb-8">
        <img
          src={image}
          alt={imageAlt || title}
          class="w-full h-72 md:h-[28rem] object-cover rounded-xl"
          loading="eager"
        />
      </div>
    )}

    <!-- Content - Constrained width for readability -->
    <div class="blog-content">
      <!-- Article Header -->
      <header class="mb-8">
        <div class="flex items-center gap-4 text-xs uppercase tracking-widest text-ink-tertiary mb-6">
          <time datetime={publishDate}>
            {new Date(publishDate).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
          {readingTime && (
            <>
              <span>·</span>
              <span>{readingTime}</span>
            </>
          )}
          {pillar && (
            <>
              <span>·</span>
              <span>{pillar.replace(/-/g, ' ')}</span>
            </>
          )}
        </div>
        <h1 class="text-3xl md:text-4xl font-light tracking-wide mb-6 leading-tight">{title}</h1>
        <p class="text-lg text-ink-secondary leading-relaxed">
          {description}
        </p>
      </header>

      <!-- Table of Contents -->
      {showToc && headings.length > 2 && (
        <TableOfContents headings={headings} />
      )}

      <hr class="section-divider" />

      <!-- Article Content -->
      <div class="blog-article-content">
        <slot />
      </div>

      <hr class="section-divider" />

      <!-- CTA Section -->
      <section class="text-center py-12">
        <h2 class="text-2xl font-light tracking-wide mb-4">READY TO BOOK YOUR TRIP?</h2>
        <p class="text-ink-secondary mb-8 max-w-md mx-auto">
          Text us where you want to go. We'll send options. You pick. We book.
        </p>
        <a href="sms:+13239224067" class="btn-primary inline-block">
          TEXT US TO START
        </a>
      </section>

      <!-- Author Bio -->
      <AuthorBio />

      <!-- Related Posts -->
      <RelatedPosts pillar={pillar} currentSlug={Astro.url.pathname} />
    </div>
  </article>
</BaseLayout>

<script>
  // Reading progress indicator
  const progressBar = document.getElementById('reading-progress');
  if (progressBar) {
    window.addEventListener('scroll', () => {
      const article = document.querySelector('article');
      if (article) {
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.scrollY;

        const progress = Math.min(
          100,
          Math.max(0, ((scrollTop - articleTop + windowHeight) / articleHeight) * 100)
        );
        progressBar.style.width = `${progress}%`;
      }
    });
  }
</script>
